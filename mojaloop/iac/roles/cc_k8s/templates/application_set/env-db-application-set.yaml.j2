{% for env_name in fact_appset_to_create %}
apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: {{ env_name }}-db-env-onboard
  namespace: argocd
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
  - git:
      repoURL: https://{{ fact_gitlab_fqdn }}/iac/{{ env_name }}.git
      revision: HEAD
      files:
      - path: merged-config/mojaloop-stateful-resources-ccdriven-databases.yaml
  template:
    metadata:
      name: '{{ env_name }}-db'
      annotations:
          argocd.argoproj.io/sync-wave: "{{ fact_argo_merged_config.apps['deploy_env'].sub_apps['onboard'].db_sync_wave }}"
    spec:
      project: default
      sources:
      - repoURL: {{ fact_argo_merged_config.gitrepo_host_fqdn }}/{{ fact_argo_merged_config.gitrepo_owner }}/{{ fact_argo_merged_config.gitrepo_repo }}.git
        targetRevision: {{ fact_argo_merged_config.apps['deploy_env'].sub_apps['config'].terraform_modules_tag }}
        path: gitops/applications/overlays/rdbms_provider/{{ '{{' }} .common_platform_db.provider {{ '}}'}}/deploy-env-onboard
        plugin:
          name: envsubst
          env:
            - name: "cluster_name"
              value: "{{ cluster_name }}"

            - name: "app_name"
              value: "{{ env_name }}-common-platform-db"

            - name: "namespace"
              value: "{{ env_name }}"

            - name: "env_name"
              value: "{{ env_name }}"

            - name: "vault_k8s_admin_auth_path"
              value: "{{ fact_argo_merged_config.apps['vault'].sub_apps['post_config'].vault_k8s_admin_auth_path }}"

            - name: "vault_k8s_admin_role_name"
              value: "{{ fact_argo_merged_config.apps['vault'].sub_apps['post_config'].vault_k8s_admin_role_name }}"

            - name: "vault_namespace"
              value: "{{ fact_argo_merged_config.apps['vault'].sub_apps['vault'].namespace }}"

            - name: "allow_major_version_upgrade"
              value: "{{ '{{' }} .common_platform_db.external_resource_config.allow_major_version_upgrade {{ '}}'}}"

            - name: "apply_immediately"
              value: "{{ '{{' }} .common_platform_db.external_resource_config.apply_immediately {{ '}}'}}"

            - name: "backup_retention_period"
              value: "{{ '{{' }} .common_platform_db.external_resource_config.backup_retention_period {{ '}}'}}"

            - name: "allocated_storage"
              value: "{{ '{{' }} .common_mojaloop_db.external_resource_config.allocated_storage {{ '}}'}}"

            - name: "deletion_protection"
              value: "{{ '{{' }} .common_mojaloop_db.external_resource_config.deletion_protection {{ '}}'}}"

            - name: "engine"
              value:  "{{ '{{' }} .common_platform_db.external_resource_config.engine {{ '}}'}}"

            - name: "family"
              value: "{{ '{{' }} .common_platform_db.external_resource_config.family {{ '}}'}}"

            - name: "port"
              value: "{{ '{{' }} .common_platform_db.external_resource_config.port {{ '}}'}}"

            - name: "preferred_backup_window"
              value: "{{ '{{' }} .common_platform_db.external_resource_config.backup_window {{ '}}'}}"

            - name: "preferred_maintenance_window"
              value: "{{ '{{' }} .common_platform_db.external_resource_config.maintenance_window {{ '}}'}}"

            - name: "final_snapshot_identifier"
              value: "{{ '{{' }} .common_platform_db.external_resource_config.final_snapshot_identifier {{ '}}'}}"

            - name: "instance_class"
              value:  "{{ '{{' }} .common_platform_db.external_resource_config.instance_class {{ '}}'}}"

            - name: "storage_encrypted"
              value:  "{{ '{{' }} .common_platform_db.external_resource_config.storage_encrypted {{ '}}'}}"

            - name: "engine_version"
              value: "{{ '{{' }} .common_platform_db.external_resource_config.engine_version {{ '}}'}}"

            - name: "instance_count"
              value: "{{ '{{' }} .common_platform_db.external_resource_config.replicas {{ '}}'}}"

            - name: "skip_final_snapshot"
              value: "{{ '{{' }} .common_platform_db.external_resource_config.skip_final_snapshot {{ '}}'}}"

            - name: "vpc_id"
              value: "{{ fact_argo_merged_config.apps['deploy_env'].sub_apps['onboard_common_platform_db_rds_provider'].rdbms_vpc_id }}"

            - name: "vpc_cidr"
              value: "{{ fact_argo_merged_config.apps['deploy_env'].sub_apps['onboard_common_platform_db_rds_provider'].vpc_cidr }}"

            - name: "subnet_list"
              value: "{{ fact_argo_merged_config.apps['deploy_env'].sub_apps['onboard_common_platform_db_rds_provider'].rdbms_subnet_list }}"

            - name: "cloud_region"
              value:  "{{ fact_argo_merged_config.apps['deploy_env'].sub_apps['onboard'].cloud_region }}"

            - name: "db_secret"
              value: "{{ env_name }}-{{ fact_argo_merged_config.apps['deploy_env'].sub_apps['onboard'].common_platform_db_secret }}"

            - name: "db_name"
              value: "{{ fact_argo_merged_config.apps['deploy_env'].sub_apps['onboard'].common_platform_db_name }}"

            - name: "db_username"
              value: "{{ '{{' }} .common_platform_db.external_resource_config.username {{ '}}'}}"

            - name: "dbdeploy_name_prefix"
              value: "{{ env_name }}-{{ fact_argo_merged_config.apps['deploy_env'].sub_apps['onboard'].common_platform_dbdeploy_name_prefix }}"

            - name: "backup_retention_period"
              value:  "{{ '{{' }} .common_platform_db.external_resource_config.backup_retention_period {{ '}}'}}"

            - name: "storage_type"
              value:  "{{ '{{' }} .common_platform_db.external_resource_config.storage_type {{ '}}'}}"

            - name: "storage_iops"
              value: "{{ '{{' }} .common_platform_db.external_resource_config.storage_iops {{ '}}'}}"

            - name: "externalservice_name"
              value: "{{ fact_argo_merged_config.apps['deploy_env'].sub_apps['onboard'].common_platform_externalservice_name }}"

            - name: max_prepared_statements
              value: "0"

            - name: "sc_dbaas_gitrepo_tag"
              value: "{{ fact_argo_merged_config.apps['deploy_env'].sub_apps['config'].terraform_modules_tag }}"

            - name: "sc_argocd_repo_url"
              value: "{{ fact_argo_merged_config.gitrepo_host_fqdn }}/{{ fact_argo_merged_config.gitrepo_owner }}/{{ fact_argo_merged_config.gitrepo_repo }}.git"

            - name: "capi_cluster_name"
              value:  "{{ fact_argo_merged_config.apps['utils'].sub_apps['capi'].capi_cluster_name }}"

            - name: "capi_cluster_namespace"
              value:  "{{ fact_argo_merged_config.apps['utils'].sub_apps['capi'].capi_cluster_namespace }}"

            - name: "cr_version"
              value: "{{ '{{' }} .common_platform_db.dbaas_resource_config.cr_version {{ '}}' }}"

            - name: "pxc_image"
              value: "{{ '{{' }} .common_platform_db.dbaas_resource_config.pxc_image {{ '}}' }}"

            - name: "percona_cluster_name"
              value: "{{ '{{' }} .common_platform_db.dbaas_resource_config.cluster_name {{ '}}' }}"

            - name: "mysql_storage_size"
              value: "{{ '{{' }} .common_platform_db.dbaas_resource_config.mysql_storage_size {{ '}}' }}"

            - name: "mysql_replicas"
              value: "{{ '{{' }} .common_platform_db.dbaas_resource_config.mysql_replicas {{ '}}' }}"

            - name: "mysql_requests_memory"
              value: "{{ '{{' }} .common_platform_db.dbaas_resource_config.mysql_requests_memory {{ '}}' }}"

            - name: "mysql_requests_cpu"
              value: "{{ '{{' }} .common_platform_db.dbaas_resource_config.mysql_requests_cpu {{ '}}' }}"

            - name: "mysql_limits_memory"
              value: "{{ '{{' }} .common_platform_db.dbaas_resource_config.mysql_limits_memory {{ '}}' }}"

            - name: "mysql_limits_cpu"
              value: "{{ '{{' }} .common_platform_db.dbaas_resource_config.mysql_limits_cpu {{ '}}' }}"

            - name: "haproxy_image"
              value: "{{ '{{' }} .common_platform_db.dbaas_resource_config.haproxy_image {{ '}}' }}"

            - name: "haproxy_expose"
              value: "{{ '{{' }} .common_platform_db.dbaas_resource_config.haproxy_expose {{ '}}' }}"

            - name: "haproxy_replicas"
              value: "{{ '{{' }} .common_platform_db.dbaas_resource_config.haproxy_replicas {{ '}}' }}"

            - name: "haproxy_requests_memory"
              value: "{{ '{{' }} .common_platform_db.dbaas_resource_config.haproxy_requests_memory {{ '}}' }}"

            - name: "haproxy_requests_cpu"
              value: "{{ '{{' }} .common_platform_db.dbaas_resource_config.haproxy_requests_cpu {{ '}}' }}"

            - name: "haproxy_limits_memory"
              value: "{{ '{{' }} .common_platform_db.dbaas_resource_config.haproxy_limits_memory {{ '}}' }}"

            - name: "haproxy_limits_cpu"
              value: "{{ '{{' }} .common_platform_db.dbaas_resource_config.haproxy_limits_cpu {{ '}}' }}"

            - name: "logcollector_image"
              value: "{{ '{{' }} .common_platform_db.dbaas_resource_config.logcollector_image {{ '}}' }}"

            - name: "logcollector_requests_memory"
              value: "{{ '{{' }} .common_platform_db.dbaas_resource_config.logcollector_requests_memory {{ '}}' }}"

            - name: "logcollector_requests_cpu"
              value: "{{ '{{' }} .common_platform_db.dbaas_resource_config.logcollector_requests_cpu {{ '}}' }}"

            - name: "logcollector_limits_memory"
              value: "{{ '{{' }} .common_platform_db.dbaas_resource_config.logcollector_limits_memory {{ '}}' }}"

            - name: "logcollector_limits_cpu"
              value: "{{ '{{' }} .common_platform_db.dbaas_resource_config.logcollector_limits_cpu {{ '}}' }}"

            - name: "backup_image"
              value: "{{ '{{' }} .common_platform_db.dbaas_resource_config.backup_image {{ '}}' }}"

            - name: "backup_verify_tls"
              value: "{{ '{{' }} .common_platform_db.dbaas_resource_config.backup_verify_tls {{ '}}' }}"

            - name: "backup_bucket_region"
              value:  "{{ fact_argo_merged_config.apps['deploy_env'].sub_apps['onboard'].cloud_region }}"

            - name: "backup_schedule_name"
              value: "{{ '{{' }} .common_platform_db.dbaas_resource_config.backup_schedule_name {{ '}}' }}"

            - name: "backup_cron_schedule"
              value: "{{ '{{' }} .common_platform_db.dbaas_resource_config.backup_cron_schedule {{ '}}' }}"

            - name: "backup_retention"
              value: "{{ '{{' }} .common_platform_db.dbaas_resource_config.backup_retention {{ '}}' }}"

            - name: "region"
              value: "{{ fact_argo_merged_config.apps['deploy_env'].sub_apps['onboard'].cloud_region }}"

            - name: "zone_id"
              value: "{{ fact_argo_merged_config.apps['deploy_env'].sub_apps['onboard'].dns_zone_id }}"

      - repoURL: {{ fact_argo_merged_config.gitrepo_host_fqdn }}/{{ fact_argo_merged_config.gitrepo_owner }}/{{ fact_argo_merged_config.gitrepo_repo }}.git
        targetRevision: {{ fact_argo_merged_config.apps['deploy_env'].sub_apps['config'].terraform_modules_tag }}
        path: gitops/applications/overlays/rdbms_provider/{{ '{{' }} .common_mojaloop_db.provider {{ '}}'}}/deploy-env-onboard
        plugin:
          name: envsubst
          env:
            - name: "cluster_name"
              value: "{{ cluster_name }}"

            - name: "app_name"
              value: "{{ env_name }}-common-mojaloop-db"

            - name: "namespace"
              value: "{{ env_name }}"

            - name: "env_name"
              value: "{{ env_name }}"

            - name: "vault_k8s_admin_auth_path"
              value: "{{ fact_argo_merged_config.apps['vault'].sub_apps['post_config'].vault_k8s_admin_auth_path }}"

            - name: "vault_k8s_admin_role_name"
              value: "{{ fact_argo_merged_config.apps['vault'].sub_apps['post_config'].vault_k8s_admin_role_name }}"

            - name: "vault_namespace"
              value: "{{ fact_argo_merged_config.apps['vault'].sub_apps['vault'].namespace }}"

            - name: "allow_major_version_upgrade"
              value: "{{ '{{' }} .common_mojaloop_db.external_resource_config.allow_major_version_upgrade {{ '}}'}}"

            - name: "apply_immediately"
              value: "{{ '{{' }} .common_mojaloop_db.external_resource_config.apply_immediately {{ '}}'}}"

            - name: "backup_retention_period"
              value: "{{ '{{' }} .common_mojaloop_db.external_resource_config.backup_retention_period {{ '}}'}}"

            - name: "deletion_protection"
              value: "{{ '{{' }} .common_mojaloop_db.external_resource_config.deletion_protection {{ '}}'}}"

            - name: "allocated_storage"
              value: "{{ '{{' }} .common_mojaloop_db.external_resource_config.allocated_storage {{ '}}'}}"

            - name: "engine"
              value:  "{{ '{{' }} .common_mojaloop_db.external_resource_config.engine {{ '}}'}}"

            - name: "family"
              value: "{{ '{{' }} .common_mojaloop_db.external_resource_config.family {{ '}}'}}"

            - name: "port"
              value: "{{ '{{' }} .common_mojaloop_db.external_resource_config.port {{ '}}'}}"

            - name: "preferred_backup_window"
              value: "{{ '{{' }} .common_mojaloop_db.external_resource_config.backup_window {{ '}}'}}"

            - name: "preferred_maintenance_window"
              value: "{{ '{{' }} .common_mojaloop_db.external_resource_config.maintenance_window {{ '}}'}}"

            - name: "final_snapshot_identifier"
              value: "{{ '{{' }} .common_mojaloop_db.external_resource_config.final_snapshot_identifier {{ '}}'}}"

            - name: "instance_class"
              value:  "{{ '{{' }} .common_mojaloop_db.external_resource_config.instance_class {{ '}}'}}"

            - name: "storage_encrypted"
              value:  "{{ '{{' }} .common_mojaloop_db.external_resource_config.storage_encrypted {{ '}}'}}"

            - name: "engine_version"
              value: "{{ '{{' }} .common_mojaloop_db.external_resource_config.engine_version {{ '}}'}}"

            - name: "instance_count"
              value: "{{ '{{' }} .common_mojaloop_db.external_resource_config.replicas {{ '}}'}}"

            - name: "skip_final_snapshot"
              value: "{{ '{{' }} .common_mojaloop_db.external_resource_config.skip_final_snapshot {{ '}}'}}"

            - name: "vpc_id"
              value: "{{ fact_argo_merged_config.apps['deploy_env'].sub_apps['onboard_common_mojaloop_db_rds_provider'].rdbms_vpc_id }}"

            - name: "vpc_cidr"
              value: "{{ fact_argo_merged_config.apps['deploy_env'].sub_apps['onboard_common_mojaloop_db_rds_provider'].vpc_cidr }}"

            - name: "subnet_list"
              value: "{{ fact_argo_merged_config.apps['deploy_env'].sub_apps['onboard_common_mojaloop_db_rds_provider'].rdbms_subnet_list }}"

            - name: "cloud_region"
              value:  "{{ fact_argo_merged_config.apps['deploy_env'].sub_apps['onboard'].cloud_region }}"

            - name: "db_secret"
              value: "{{ env_name }}-{{ fact_argo_merged_config.apps['deploy_env'].sub_apps['onboard'].common_mojaloop_db_secret }}"

            - name: "db_name"
              value: "{{ fact_argo_merged_config.apps['deploy_env'].sub_apps['onboard'].common_mojaloop_db_name }}"

            - name: "db_username"
              value:  "{{ '{{' }} .common_mojaloop_db.external_resource_config.username {{ '}}'}}"

            - name: "dbdeploy_name_prefix"
              value: "{{ env_name }}-{{ fact_argo_merged_config.apps['deploy_env'].sub_apps['onboard'].common_mojaloop_dbdeploy_name_prefix }}"

            - name: "backup_retention_period"
              value:  "{{ '{{' }} .common_mojaloop_db.external_resource_config.backup_retention_period {{ '}}'}}"

            - name: "storage_type"
              value:  "{{ '{{' }} .common_mojaloop_db.external_resource_config.storage_type {{ '}}'}}"

            - name: "storage_iops"
              value: "{{ '{{' }} .common_mojaloop_db.external_resource_config.storage_iops {{ '}}'}}"

            - name: "externalservice_name"
              value: "{{ fact_argo_merged_config.apps['deploy_env'].sub_apps['onboard'].common_mojaloop_externalservice_name }}"

            - name: max_prepared_statements
              value: "0"

            - name: "sc_dbaas_gitrepo_tag"
              value: "{{ fact_argo_merged_config.apps['deploy_env'].sub_apps['config'].terraform_modules_tag }}"

            - name: "sc_argocd_repo_url"
              value: "{{ fact_argo_merged_config.gitrepo_host_fqdn }}/{{ fact_argo_merged_config.gitrepo_owner }}/{{ fact_argo_merged_config.gitrepo_repo }}.git"

            - name: "capi_cluster_name"
              value:  "{{ fact_argo_merged_config.apps['utils'].sub_apps['capi'].capi_cluster_name }}"

            - name: "capi_cluster_namespace"
              value:  "{{ fact_argo_merged_config.apps['utils'].sub_apps['capi'].capi_cluster_namespace }}"

            - name: "cr_version"
              value: "{{ '{{' }} .common_mojaloop_db.dbaas_resource_config.cr_version {{ '}}' }}"

            - name: "pxc_image"
              value: "{{ '{{' }} .common_mojaloop_db.dbaas_resource_config.pxc_image {{ '}}' }}"

            - name: "pxc_volume_spec"
              value: "{{ '{{' }} ternary \"\" (.common_mojaloop_db.dbaas_resource_config.pxc_volume_spec | toRawJson) (empty (index .common_mojaloop_db.dbaas_resource_config "pxc_volume_spec")) {{ '}}' }}"

            - name: "pxc_annotations"
              value: "{{ '{{' }} ternary \"\" (.common_mojaloop_db.dbaas_resource_config.pxc_annotations | toRawJson) (empty (index .common_mojaloop_db.dbaas_resource_config "pxc_annotations")) {{ '}}' }}"

            - name: "percona_cluster_name"
              value: "{{ '{{' }} .common_mojaloop_db.dbaas_resource_config.cluster_name {{ '}}' }}"

            - name: "mysql_storage_size"
              value: "{{ '{{' }} .common_mojaloop_db.dbaas_resource_config.mysql_storage_size {{ '}}' }}"

            - name: "mysql_replicas"
              value: "{{ '{{' }} .common_mojaloop_db.dbaas_resource_config.mysql_replicas {{ '}}' }}"

            - name: "mysql_requests_memory"
              value: "{{ '{{' }} .common_mojaloop_db.dbaas_resource_config.mysql_requests_memory {{ '}}' }}"

            - name: "mysql_requests_cpu"
              value: "{{ '{{' }} .common_mojaloop_db.dbaas_resource_config.mysql_requests_cpu {{ '}}' }}"

            - name: "mysql_limits_memory"
              value: "{{ '{{' }} .common_mojaloop_db.dbaas_resource_config.mysql_limits_memory {{ '}}' }}"

            - name: "mysql_limits_cpu"
              value: "{{ '{{' }} .common_mojaloop_db.dbaas_resource_config.mysql_limits_cpu {{ '}}' }}"

            - name: "haproxy_image"
              value: "{{ '{{' }} .common_mojaloop_db.dbaas_resource_config.haproxy_image {{ '}}' }}"

            - name: "haproxy_expose"
              value: "{{ '{{' }} .common_mojaloop_db.dbaas_resource_config.haproxy_expose {{ '}}' }}"

            - name: "haproxy_replicas"
              value: "{{ '{{' }} .common_mojaloop_db.dbaas_resource_config.haproxy_replicas {{ '}}' }}"

            - name: "haproxy_requests_memory"
              value: "{{ '{{' }} .common_mojaloop_db.dbaas_resource_config.haproxy_requests_memory {{ '}}' }}"

            - name: "haproxy_requests_cpu"
              value: "{{ '{{' }} .common_mojaloop_db.dbaas_resource_config.haproxy_requests_cpu {{ '}}' }}"

            - name: "haproxy_limits_memory"
              value: "{{ '{{' }} .common_mojaloop_db.dbaas_resource_config.haproxy_limits_memory {{ '}}' }}"

            - name: "haproxy_limits_cpu"
              value: "{{ '{{' }} .common_mojaloop_db.dbaas_resource_config.haproxy_limits_cpu {{ '}}' }}"

            - name: "logcollector_image"
              value: "{{ '{{' }} .common_mojaloop_db.dbaas_resource_config.logcollector_image {{ '}}' }}"

            - name: "logcollector_requests_memory"
              value: "{{ '{{' }} .common_mojaloop_db.dbaas_resource_config.logcollector_requests_memory {{ '}}' }}"

            - name: "logcollector_requests_cpu"
              value: "{{ '{{' }} .common_mojaloop_db.dbaas_resource_config.logcollector_requests_cpu {{ '}}' }}"

            - name: "logcollector_limits_memory"
              value: "{{ '{{' }} .common_mojaloop_db.dbaas_resource_config.logcollector_limits_memory {{ '}}' }}"

            - name: "logcollector_limits_cpu"
              value: "{{ '{{' }} .common_mojaloop_db.dbaas_resource_config.logcollector_limits_cpu {{ '}}' }}"

            - name: "backup_image"
              value: "{{ '{{' }} .common_mojaloop_db.dbaas_resource_config.backup_image {{ '}}' }}"

            - name: "backup_verify_tls"
              value: "{{ '{{' }} .common_mojaloop_db.dbaas_resource_config.backup_verify_tls {{ '}}' }}"

            - name: "backup_bucket_region"
              value:  "{{ fact_argo_merged_config.apps['deploy_env'].sub_apps['onboard'].cloud_region }}"

            - name: "backup_schedule_name"
              value: "{{ '{{' }} .common_mojaloop_db.dbaas_resource_config.backup_schedule_name {{ '}}' }}"

            - name: "backup_cron_schedule"
              value: "{{ '{{' }} .common_mojaloop_db.dbaas_resource_config.backup_cron_schedule {{ '}}' }}"

            - name: "backup_retention"
              value: "{{ '{{' }} .common_mojaloop_db.dbaas_resource_config.backup_retention {{ '}}' }}"

            - name: "backup_pvc"
              value: "{{ '{{' }} ternary \"\" (.common_mojaloop_db.dbaas_resource_config.backup_pvc | toRawJson) (empty (index .common_mojaloop_db.dbaas_resource_config "backup_pvc")) {{ '}}' }}"

            - name: "region"
              value: "{{ fact_argo_merged_config.apps['deploy_env'].sub_apps['onboard'].cloud_region }}"

            - name: "zone_id"
              value: "{{ fact_argo_merged_config.apps['deploy_env'].sub_apps['onboard'].dns_zone_id }}"

      destination:
        server: https://kubernetes.default.svc
        namespace: 'argocd'
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
        - CreateNamespace=true
        - PrunePropagationPolicy=foreground
        - PruneLast=true
---
{% endfor %}